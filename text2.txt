import StoreService from "./Services/StoreService.mjs";
import ProductService from "./Services/ProductService.mjs";
import AnimationService from "./Services/AnimationService.mjs";
import CartService from "./Services/CartService.mjs";

const initialState = [];

export const productElements = {
    productGroup: document.querySelector(".product-group"),
    cart: document.querySelector(".cart"),
};

export default function handlerDrag(event) {
    const item = event.target.closest(".product-group-item");
    const { clientX, clientY } = ProductService.getCoordinats(event);

    item.classList.add("selected");
    AnimationService.cartAddScale();
    item.style.left = event.pageX - clientX + "px";
    item.style.top = event.pageY - clientY + "px";

    document.addEventListener("mousemove", onMouseMove);

    function moveAt(pageX, pageY) {
        item.style.left = pageX - clientX + "px";
        item.style.top = pageY - clientY + "px";
    }

    function onMouseMove(event) {
        moveAt(event.pageX, event.pageY);
    }

    productElements.productGroup.addEventListener("mouseup", (event) => {
        item.classList.remove("selected");
        AnimationService.cartRemoveScale();
        document.removeEventListener("mousemove", onMouseMove);
        insertToCart(item, event);
    });

    item.ondragstart = function () {
        return false;
    };
}

function insertToCart(item, event) {
    const { clientX, clientY } = ProductService.getCoordinats(event);
    item.hidden = true;
    let requiereElement = document.elementFromPoint(clientX, clientY - 50).closest(".cart");
    item.hidden = false;
    if (requiereElement === productElements.cart) {
        CartService.whenProductOverCart(item, initialState);
        ProductService.addProductIntoCart(item);
        if (StoreService.completed) {
            productElements.productGroup.removeEventListener("mousedown", handlerDrag);
            CartService.whenCartFull();
        }
    }
}

